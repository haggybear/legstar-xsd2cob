<!-- =================================================================================
     This script tests the distribution file. It unzips the distro to a temporary
     location and runs the samples.
 -->
<project basedir="../../.." default="testDistro" name="build-sample">

    <!-- ===========================================================  -->
    <!-- Setup environment
    -->
    <target name="init">
        <xmlproperty file="${basedir}/pom.xml"/>
        
        <property environment="env"/>
        <!-- Temporary location  -->
        <property name="test.dir" value="${basedir}/target/test-distro" />
        <!-- Distribution name  -->
        <property name="dist.name" value="${project.artifactId}-${project.version}" />
        <!-- Distribution zip file  -->
        <property name="dist.zip" value="${dist.name}.zip" />
        <!-- Distribution file location   -->
        <property name="dist.dir" value="${basedir}/target" />
        <!-- Distribution zip file   -->
        <property name="zip.file" value="${dist.dir}/${dist.zip}" />
        <!-- Sample generated COBOL-annotated XML schema -->
        <property name="xsdSampleFilePath" value="${test.dir}/${dist.name}/cobol/customertype.xsd"/>
        <!-- Sample generated COBOL copybook -->
        <property name="cobolSampleFilePath" value="${test.dir}/${dist.name}/cobol/customertype.cpy"/>
    
    </target>

    <!-- ===========================================================  -->
    <!-- Unzip distro to temporary location
    -->
    <target name="installDistro" depends="init">
        <unzip src="${zip.file}" dest="${test.dir}"/>
    </target>
    
    <!-- ===========================================================  -->
    <!-- Run the sample executable jar
    -->
    <target name="testExecutable" depends="installDistro">
        <delete file="${jarSampleFilePath}"/>
        <exec dir="${test.dir}/${dist.name}" executable="cmd" failonerror="true">
            <arg value="/c"/>
            <arg value="run"/>
        </exec>
        <available file="${xsdSampleFilePath}" property="isXsdSampleFilePath"/>
        <fail unless="isXsdSampleFilePath" message="Run.bat failed!"/>
        <available file="${cobolSampleFilePath}" property="isCobolSampleFilePath"/>
        <fail unless="isCobolSampleFilePath" message="Run.bat failed!"/>
    </target>

  <!-- ===========================================================  -->
    <!-- Run the samples
    -->
    <target name="testDistro" depends="testExecutable"/>
</project>
